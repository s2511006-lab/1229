import streamlit as st
import pandas as pd
import folium
from streamlit_folium import st_folium
from geopy.distance import geodesic

# -----------------------------------------------------------------------------
# 1. í˜ì´ì§€ ì„¤ì • ë° ë””ìì¸
# -----------------------------------------------------------------------------
st.set_page_config(
    page_title="ì„œì´ˆêµ¬ ì˜ë¥˜ìˆ˜ê±°í•¨ ì—ì½”ë§µ",
    page_icon="â™»ï¸",
    layout="wide"
)

# ìŠ¤íƒ€ì¼ë§ (CSS)
st.markdown("""
    <style>
    .main_title {
        font-size: 40px;
        font-weight: bold;
        color: #2E8B57;
        text-align: center;
        margin-bottom: 10px;
    }
    .sub_text {
        font-size: 18px;
        color: #555;
        text-align: center;
        margin-bottom: 30px;
    }
    .highlight {
        background-color: #f0f2f6;
        padding: 15px;
        border-radius: 10px;
        border-left: 5px solid #2E8B57;
    }
    </style>
""", unsafe_allow_html=True)

# -----------------------------------------------------------------------------
# 2. ë°ì´í„° ë¡œë“œ í•¨ìˆ˜
# -----------------------------------------------------------------------------
@st.cache_data
def load_data():
    # ì—…ë¡œë“œëœ íŒŒì¼ëª…ì„ ì—¬ê¸°ì— ì…ë ¥í•˜ì„¸ìš”. 
    # ë¡œì»¬ í…ŒìŠ¤íŠ¸ ì‹œ íŒŒì¼ëª…ì´ ë§ëŠ”ì§€ í™•ì¸ í•„ìš” (ì—¬ê¸°ì„œëŠ” ì˜ˆì‹œ íŒŒì¼ëª… ì‚¬ìš©)
    file_path = "seocho_cloth_bins.csv" 
    
    try:
        # ê³µê³µë°ì´í„°ëŠ” ë³´í†µ cp949 ì¸ì½”ë”©ì´ ë§ìŒ, ì‹¤íŒ¨ì‹œ utf-8 ì‹œë„
        df = pd.read_csv(file_path, encoding='cp949')
    except:
        df = pd.read_csv(file_path, encoding='utf-8')
    
    # í•„ìš”í•œ ì»¬ëŸ¼ë§Œ ì¶”ì¶œ ë° ê²°ì¸¡ì¹˜ ì œê±°
    required_cols = ['ì„¤ì¹˜ì¥ì†Œëª…', 'ì†Œì¬ì§€ë„ë¡œëª…ì£¼ì†Œ', 'ìƒì„¸ìœ„ì¹˜', 'ìœ„ë„', 'ê²½ë„']
    df = df[required_cols].dropna(subset=['ìœ„ë„', 'ê²½ë„'])
    return df

# -----------------------------------------------------------------------------
# 3. ë©”ì¸ UI êµ¬ì„±
# -----------------------------------------------------------------------------

# í—¤ë” ì„¹ì…˜
st.markdown('<div class="main_title">â™»ï¸ ì„œì´ˆêµ¬ ì˜ë¥˜ìˆ˜ê±°í•¨ ì—ì½”ë§µ</div>', unsafe_allow_html=True)
st.markdown("""
<div class="sub_text">
    íŒ¨ìŠ¤íŠ¸íŒ¨ì…˜ìœ¼ë¡œ ì¸í•´ ë²„ë ¤ì§€ëŠ” ì˜·ë“¤ì´ í™˜ê²½ì„ ì•„í”„ê²Œ í•˜ê³  ìˆìŠµë‹ˆë‹¤.<br>
    ê°€ê¹Œìš´ ì˜ë¥˜ìˆ˜ê±°í•¨ì„ ì°¾ì•„ ì†Œì¤‘í•œ ìì›ì„ ì¬í™œìš©í•´ì£¼ì„¸ìš”.
</div>
""", unsafe_allow_html=True)

# ì‚¬ì´ë“œë°”: ë¬¸ì œ ì •ì˜ ë° ì‚¬ìš©ë²•
with st.sidebar:
    st.header("ğŸŒ ì™œ ì´ ì•±ì´ í•„ìš”í•œê°€ìš”?")
    st.info("""
    **ë¬¸ì œì :**
    ìœ í–‰ì— ë”°ë¼ ì˜·ì„ ì‰½ê²Œ ì‚¬ê³  ì‰½ê²Œ ë²„ë¦¬ëŠ” 'íŒ¨ìŠ¤íŠ¸íŒ¨ì…˜' íŠ¸ë Œë“œë¡œ ì¸í•´ ì˜ë¥˜ íê¸°ë¬¼ì´ ê¸‰ì¦í•˜ê³  ìˆìŠµë‹ˆë‹¤.
    
    **ìš°ë¦¬ì˜ ëª©í‘œ:**
    ì„œì´ˆêµ¬ ì£¼ë¯¼ë“¤ì´ ê°€ì¥ ê°€ê¹Œìš´ ìˆ˜ê±°í•¨ì„ ì‰½ê²Œ ì°¾ì•„ ì˜ë¥˜ ì¬í™œìš©ë¥ ì„ ë†’ì´ëŠ” ê²ƒì…ë‹ˆë‹¤.
    """)
    st.divider()
    st.write("**ë°ì´í„° ì¶œì²˜:** ì„œì´ˆêµ¬ì²­ (2025-02-18 ê¸°ì¤€)")

# ë°ì´í„° ë¡œë”©
try:
    # *ì¤‘ìš”: ì‹¤ì œ ì‚¬ìš©ì‹œì—ëŠ” íŒŒì¼ëª…ì„ ì—…ë¡œë“œí•œ íŒŒì¼ëª…ìœ¼ë¡œ ë³€ê²½í•˜ê±°ë‚˜ íŒŒì¼ ì—…ë¡œë”ë¥¼ ì‚¬ìš©í•´ì•¼ í•¨
    # ì—¬ê¸°ì„œëŠ” ìŠ¤íŠ¸ë¦¼ë¦¿ í´ë¼ìš°ë“œ ë°°í¬ë¥¼ ìœ„í•´ íŒŒì¼ì´ ê°™ì€ í´ë”ì— ìˆë‹¤ê³  ê°€ì •
    # ì‚¬ìš©ìê°€ ì§ì ‘ ì—…ë¡œë“œ ê¸°ëŠ¥ì„ ì›í•  ê²½ìš°ë¥¼ ëŒ€ë¹„í•œ ì½”ë“œ:
    uploaded_file = st.file_uploader("CSV íŒŒì¼ ì—…ë¡œë“œ (ë°ì´í„°ê°€ ì—†ë‹¤ë©´ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”)", type=['csv'])
    
    if uploaded_file is not None:
         df = pd.read_csv(uploaded_file, encoding='cp949') # í˜¹ì€ utf-8
    else:
        # ê¸°ë³¸ íŒŒì¼ ë¡œë“œ ì‹œë„ (íŒŒì¼ëª…ì€ ì‚¬ìš©ìê°€ ì˜¬ë¦° íŒŒì¼ëª…ìœ¼ë¡œ ìˆ˜ì • í•„ìš”)
        # ì˜ˆì‹œ ì½”ë“œì—ì„œëŠ” ì‚¬ìš©ìê°€ ì¤€ íŒŒì¼ëª…ì„ ê·¸ëŒ€ë¡œ ì“´ë‹¤ê³  ê°€ì •
        df = pd.read_csv("________________20250218.csv", encoding='cp949') # íŒŒì¼ëª… ìˆ˜ì • í•„ìš”

except Exception as e:
    st.error(f"ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. CSV íŒŒì¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”. ì—ëŸ¬: {e}")
    st.stop()

# -----------------------------------------------------------------------------
# 4. ë‚´ ìœ„ì¹˜ ì„¤ì • ë° ê±°ë¦¬ ê³„ì‚° ë¡œì§
# -----------------------------------------------------------------------------

col1, col2 = st.columns([1, 2])

with col1:
    st.markdown("### ğŸ“ ë‚´ ìœ„ì¹˜ ì„¤ì •")
    st.write("í˜„ì¬ ìœ„ì¹˜ì™€ ê°€ì¥ ê°€ê¹Œìš´ ëœë“œë§ˆí¬ë¥¼ ì„ íƒí•˜ì„¸ìš”.")
    
    # ì„œì´ˆêµ¬ ì£¼ìš” ê±°ì  ì¢Œí‘œ (ì˜ˆì‹œ)
    landmarks = {
        "ì„œì´ˆêµ¬ì²­ (ê¸°ë³¸)": (37.483574, 127.032692),
        "ê°•ë‚¨ì—­": (37.498095, 127.027610),
        "êµëŒ€ì—­": (37.493968, 127.014658),
        "ê³ ì†í„°ë¯¸ë„": (37.504914, 127.004915),
        "ì–‘ì¬ì—­": (37.484147, 127.034631),
        "ë°©ë°°ì—­": (37.481533, 126.997637)
    }
    
    selected_landmark = st.selectbox("ì£¼ë³€ ëœë“œë§ˆí¬ ì„ íƒ", list(landmarks.keys()))
    user_location = landmarks[selected_landmark]
    
    st.info(f"ì„ íƒëœ ìœ„ì¹˜: **{selected_landmark}**")
    
    # ê±°ë¦¬ ê³„ì‚°
    def calculate_distance(row):
        bin_loc = (row['ìœ„ë„'], row['ê²½ë„'])
        return geodesic(user_location, bin_loc).meters

    df['ê±°ë¦¬(m)'] = df.apply(calculate_distance, axis=1)
    
    # ê°€ì¥ ê°€ê¹Œìš´ ìˆ˜ê±°í•¨ 5ê°œ ì¶”ì¶œ
    nearest_bins = df.sort_values(by='ê±°ë¦¬(m)').head(5)
    
    st.markdown("### ğŸƒ ê°€ì¥ ê°€ê¹Œìš´ ìˆ˜ê±°í•¨ TOP 5")
    for idx, row in nearest_bins.iterrows():
        with st.expander(f"ğŸ“ {row['ì„¤ì¹˜ì¥ì†Œëª…']} ({int(row['ê±°ë¦¬(m)'])}m)"):
            st.write(f"**ì£¼ì†Œ:** {row['ì†Œì¬ì§€ë„ë¡œëª…ì£¼ì†Œ']}")
            st.write(f"**ìƒì„¸ìœ„ì¹˜:** {row['ìƒì„¸ìœ„ì¹˜']}")

with col2:
    st.markdown("### ğŸ—ºï¸ ì˜ë¥˜ìˆ˜ê±°í•¨ ì§€ë„")
    
    # ì§€ë„ ìƒì„± (ì‚¬ìš©ì ìœ„ì¹˜ ì¤‘ì‹¬)
    m = folium.Map(location=user_location, zoom_start=15)
    
    # ì‚¬ìš©ì ìœ„ì¹˜ ë§ˆì»¤ (ë¹¨ê°„ìƒ‰)
    folium.Marker(
        user_location,
        popup="ë‚´ ìœ„ì¹˜ (ì„ íƒë¨)",
        icon=folium.Icon(color='red', icon='user')
    ).add_to(m)
    
    # ì „ì²´ ìˆ˜ê±°í•¨ ë§ˆì»¤ í´ëŸ¬ìŠ¤í„°ë§ì„ ì›í•˜ë©´ MarkerCluster ì‚¬ìš© ê°€ëŠ¥í•˜ì§€ë§Œ,
    # ì—¬ê¸°ì„œëŠ” ê°€ê¹Œìš´ ê³³ì„ ê°•ì¡°í•˜ê¸° ìœ„í•´ ì¼ë°˜ ë§ˆì»¤ ì‚¬ìš©
    
    # 1. ê°€ì¥ ê°€ê¹Œìš´ 5ê°œëŠ” ì´ˆë¡ìƒ‰(ëˆˆì— ë„ê²Œ)
    for idx, row in nearest_bins.iterrows():
        folium.Marker(
            [row['ìœ„ë„'], row['ê²½ë„']],
            popup=f"<b>{row['ì„¤ì¹˜ì¥ì†Œëª…']}</b><br>{int(row['ê±°ë¦¬(m)'])}m",
            tooltip=row['ì„¤ì¹˜ì¥ì†Œëª…'],
            icon=folium.Icon(color='green', icon='recycle', prefix='fa')
        ).add_to(m)
        
    # 2. ë‚˜ë¨¸ì§€ëŠ” ì‘ê²Œ íŒŒë€ìƒ‰ (ì˜µì…˜: ë„ˆë¬´ ë§ìœ¼ë©´ ì§€ë„ ë¡œë”© ëŠë ¤ì§ˆ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì œì™¸í•˜ê±°ë‚˜ í´ëŸ¬ìŠ¤í„°ë§ ì¶”ì²œ)
    # ì „ì²´ ë°ì´í„°ë¥¼ ë‹¤ ë³´ì—¬ì£¼ë ¤ë©´ ì•„ë˜ ì£¼ì„ í•´ì œ
    # from folium.plugins import MarkerCluster
    # marker_cluster = MarkerCluster().add_to(m)
    # for idx, row in df.iterrows():
    #     if row['ì„¤ì¹˜ì¥ì†Œëª…'] not in nearest_bins['ì„¤ì¹˜ì¥ì†Œëª…'].values:
    #         folium.Marker(
    #             [row['ìœ„ë„'], row['ê²½ë„']],
    #             popup=row['ì„¤ì¹˜ì¥ì†Œëª…'],
    #             icon=folium.Icon(color='blue', icon='info-sign')
    #         ).add_to(marker_cluster)

    st_folium(m, width="100%", height=600)

# -----------------------------------------------------------------------------
# 5. í‘¸í„° (í–‰ë™ ìœ ë„)
# -----------------------------------------------------------------------------
st.divider()
st.markdown("""
    <div style="text-align: center; color: #888;">
        <p>ì‘ì€ ì‹¤ì²œì´ ëª¨ì—¬ ê¹¨ë—í•œ ì§€êµ¬ë¥¼ ë§Œë“­ë‹ˆë‹¤. ì˜¤ëŠ˜ ì•ˆ ì…ëŠ” ì˜·ì„ ì •ë¦¬í•´ë³´ëŠ” ê±´ ì–´ë–¨ê¹Œìš”?</p>
    </div>
""", unsafe_allow_html=True)
